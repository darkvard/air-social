events {
    # Maximum number of simultaneous connections that can be opened by a worker process
    worker_connections 1024;
}

http {
    # Increase upload size limit to 10MB (Recommended for high-res images)
    # Default Nginx limit is 1MB, which is too small for modern avatars/covers.
    client_max_body_size 10M;

    # --- UPSTREAM DEFINITIONS ---
    # Define groups of servers to reference in proxy_pass

    upstream backend_api {
        server app:8080;  # Internal Docker DNS name for the Go app
    }

    upstream minio_storage {
        server minio:9000; # MinIO API port
    }

    upstream minio_console {
        server minio:9001; # MinIO Web Console port
    }

    upstream rabbitmq_console {
        server rabbitmq:15672; # RabbitMQ Management UI
    }

    # --- SERVER CONFIGURATION ---
    server {
        listen 80; 
        server_name localhost;

        # 1. API Routing
        # Requests to http://localhost/api/... are forwarded to the Go Backend
        location /api/ {
            proxy_pass http://backend_api; 
            
            # Standard headers for reverse proxying
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # 2. Public File Access (MinIO)
        # Requests to http://localhost/air-social-public/... are forwarded to MinIO
        # This matches the Public URL structure stored in the database.
        location /air-social-public/ {
            proxy_pass http://minio_storage/air-social-public/;
            
            # [IMPORTANT] "Hack" the Host header to trick MinIO
            # MinIO verifies the signature based on the Host. 
            # Since the backend signed it for "minio:9000", we must forward that host.
            proxy_set_header Host minio:9000; 
        }

        # 3. MinIO Admin Console
        # Access via: http://localhost/storage-admin/
        location /storage-admin/ {
            proxy_pass http://minio_console/;
            
            # Required headers for WebSocket support (MinIO Console uses WS)
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            chunked_transfer_encoding off;
        }

        # 4. RabbitMQ Management UI
        # Access via: http://localhost/rabbitmq/
        # Note: Requires RabbitMQ to be configured with path_prefix="/rabbitmq"
        location /rabbitmq/ {
            proxy_pass http://rabbitmq_console;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}